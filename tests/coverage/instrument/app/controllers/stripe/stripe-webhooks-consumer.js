
var __cov_rYQ1ztjy4CjvY$3sjs_pLQ = (Function('return this'))();
if (!__cov_rYQ1ztjy4CjvY$3sjs_pLQ.__coverage__) { __cov_rYQ1ztjy4CjvY$3sjs_pLQ.__coverage__ = {}; }
__cov_rYQ1ztjy4CjvY$3sjs_pLQ = __cov_rYQ1ztjy4CjvY$3sjs_pLQ.__coverage__;
if (!(__cov_rYQ1ztjy4CjvY$3sjs_pLQ['app/controllers/stripe/stripe-webhooks-consumer.js'])) {
   __cov_rYQ1ztjy4CjvY$3sjs_pLQ['app/controllers/stripe/stripe-webhooks-consumer.js'] = {"path":"app/controllers/stripe/stripe-webhooks-consumer.js","s":{"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0},"b":{"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0],"8":[0,0],"9":[0,0],"10":[0,0]},"f":{"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0},"fnMap":{"1":{"name":"(anonymous_1)","line":4,"loc":{"start":{"line":4,"column":17},"end":{"line":4,"column":36}}},"2":{"name":"(anonymous_2)","line":13,"loc":{"start":{"line":13,"column":62},"end":{"line":13,"column":82}}},"3":{"name":"(anonymous_3)","line":17,"loc":{"start":{"line":17,"column":108},"end":{"line":17,"column":123}}},"4":{"name":"(anonymous_4)","line":24,"loc":{"start":{"line":24,"column":70},"end":{"line":24,"column":90}}},"5":{"name":"(anonymous_5)","line":28,"loc":{"start":{"line":28,"column":18},"end":{"line":28,"column":47}}},"6":{"name":"(anonymous_6)","line":38,"loc":{"start":{"line":38,"column":23},"end":{"line":38,"column":38}}},"7":{"name":"(anonymous_7)","line":39,"loc":{"start":{"line":39,"column":63},"end":{"line":39,"column":88}}},"8":{"name":"(anonymous_8)","line":44,"loc":{"start":{"line":44,"column":123},"end":{"line":44,"column":138}}},"9":{"name":"(anonymous_9)","line":58,"loc":{"start":{"line":58,"column":13},"end":{"line":58,"column":42}}},"10":{"name":"(anonymous_10)","line":60,"loc":{"start":{"line":60,"column":53},"end":{"line":60,"column":78}}},"11":{"name":"(anonymous_11)","line":67,"loc":{"start":{"line":67,"column":118},"end":{"line":67,"column":133}}},"12":{"name":"(anonymous_12)","line":84,"loc":{"start":{"line":84,"column":28},"end":{"line":84,"column":43}}},"13":{"name":"(anonymous_13)","line":87,"loc":{"start":{"line":87,"column":33},"end":{"line":87,"column":62}}},"14":{"name":"(anonymous_14)","line":88,"loc":{"start":{"line":88,"column":106},"end":{"line":88,"column":135}}},"15":{"name":"(anonymous_15)","line":91,"loc":{"start":{"line":91,"column":133},"end":{"line":91,"column":148}}}},"statementMap":{"1":{"start":{"line":1,"column":0},"end":{"line":2,"column":97}},"2":{"start":{"line":4,"column":0},"end":{"line":113,"column":1}},"3":{"start":{"line":6,"column":5},"end":{"line":6,"column":46}},"4":{"start":{"line":7,"column":5},"end":{"line":7,"column":75}},"5":{"start":{"line":11,"column":5},"end":{"line":21,"column":6}},"6":{"start":{"line":12,"column":10},"end":{"line":12,"column":59}},"7":{"start":{"line":13,"column":10},"end":{"line":20,"column":13}},"8":{"start":{"line":14,"column":15},"end":{"line":16,"column":18}},"9":{"start":{"line":17,"column":15},"end":{"line":19,"column":18}},"10":{"start":{"line":22,"column":5},"end":{"line":53,"column":6}},"11":{"start":{"line":23,"column":10},"end":{"line":23,"column":77}},"12":{"start":{"line":24,"column":10},"end":{"line":52,"column":13}},"13":{"start":{"line":26,"column":15},"end":{"line":51,"column":18}},"14":{"start":{"line":29,"column":20},"end":{"line":50,"column":23}},"15":{"start":{"line":39,"column":25},"end":{"line":49,"column":27}},"16":{"start":{"line":40,"column":30},"end":{"line":43,"column":33}},"17":{"start":{"line":44,"column":30},"end":{"line":48,"column":33}},"18":{"start":{"line":45,"column":35},"end":{"line":47,"column":36}},"19":{"start":{"line":46,"column":40},"end":{"line":46,"column":47}},"20":{"start":{"line":54,"column":5},"end":{"line":102,"column":6}},"21":{"start":{"line":55,"column":10},"end":{"line":55,"column":40}},"22":{"start":{"line":56,"column":10},"end":{"line":101,"column":13}},"23":{"start":{"line":59,"column":15},"end":{"line":59,"column":57}},"24":{"start":{"line":60,"column":15},"end":{"line":100,"column":18}},"25":{"start":{"line":61,"column":20},"end":{"line":61,"column":54}},"26":{"start":{"line":62,"column":20},"end":{"line":99,"column":21}},"27":{"start":{"line":63,"column":25},"end":{"line":66,"column":28}},"28":{"start":{"line":67,"column":25},"end":{"line":71,"column":28}},"29":{"start":{"line":68,"column":30},"end":{"line":70,"column":31}},"30":{"start":{"line":69,"column":35},"end":{"line":69,"column":42}},"31":{"start":{"line":74,"column":25},"end":{"line":98,"column":27}},"32":{"start":{"line":85,"column":30},"end":{"line":97,"column":33}},"33":{"start":{"line":88,"column":35},"end":{"line":96,"column":44}},"34":{"start":{"line":89,"column":37},"end":{"line":89,"column":89}},"35":{"start":{"line":90,"column":40},"end":{"line":90,"column":119}},"36":{"start":{"line":91,"column":40},"end":{"line":95,"column":43}},"37":{"start":{"line":92,"column":45},"end":{"line":94,"column":46}},"38":{"start":{"line":93,"column":50},"end":{"line":93,"column":57}},"39":{"start":{"line":103,"column":5},"end":{"line":105,"column":6}},"40":{"start":{"line":106,"column":5},"end":{"line":108,"column":6}},"41":{"start":{"line":109,"column":5},"end":{"line":111,"column":6}}},"branchMap":{"1":{"line":11,"type":"if","locations":[{"start":{"line":11,"column":5},"end":{"line":11,"column":5}},{"start":{"line":11,"column":5},"end":{"line":11,"column":5}}]},"2":{"line":22,"type":"if","locations":[{"start":{"line":22,"column":5},"end":{"line":22,"column":5}},{"start":{"line":22,"column":5},"end":{"line":22,"column":5}}]},"3":{"line":45,"type":"if","locations":[{"start":{"line":45,"column":35},"end":{"line":45,"column":35}},{"start":{"line":45,"column":35},"end":{"line":45,"column":35}}]},"4":{"line":54,"type":"if","locations":[{"start":{"line":54,"column":5},"end":{"line":54,"column":5}},{"start":{"line":54,"column":5},"end":{"line":54,"column":5}}]},"5":{"line":62,"type":"if","locations":[{"start":{"line":62,"column":20},"end":{"line":62,"column":20}},{"start":{"line":62,"column":20},"end":{"line":62,"column":20}}]},"6":{"line":68,"type":"if","locations":[{"start":{"line":68,"column":30},"end":{"line":68,"column":30}},{"start":{"line":68,"column":30},"end":{"line":68,"column":30}}]},"7":{"line":92,"type":"if","locations":[{"start":{"line":92,"column":45},"end":{"line":92,"column":45}},{"start":{"line":92,"column":45},"end":{"line":92,"column":45}}]},"8":{"line":103,"type":"if","locations":[{"start":{"line":103,"column":5},"end":{"line":103,"column":5}},{"start":{"line":103,"column":5},"end":{"line":103,"column":5}}]},"9":{"line":106,"type":"if","locations":[{"start":{"line":106,"column":5},"end":{"line":106,"column":5}},{"start":{"line":106,"column":5},"end":{"line":106,"column":5}}]},"10":{"line":109,"type":"if","locations":[{"start":{"line":109,"column":5},"end":{"line":109,"column":5}},{"start":{"line":109,"column":5},"end":{"line":109,"column":5}}]}}};
}
__cov_rYQ1ztjy4CjvY$3sjs_pLQ = __cov_rYQ1ztjy4CjvY$3sjs_pLQ['app/controllers/stripe/stripe-webhooks-consumer.js'];
__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['1']++;var utils=require('../../utils'),subscriptionController=require('../../controllers/subscriptions/subscription-controller');__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['2']++;module.exports=function(ref,cb){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['1']++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['3']++;var subObj=ref.stripeEvent.data.object;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['4']++;console.log('stripe-webhooks-consumer ref:',subObj,ref.stripeEvent);__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['5']++;if(ref.stripeEvent.type==='invoice.created'){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['1'][0]++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['6']++;console.log('stripe-webhook -> invoice.created');__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['7']++;utils.fetchActivityByCustomer(subObj.customer).then(function(activity){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['2']++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['8']++;var emailContent=utils.formatEmailContent('invoice.created',{amount_due:subObj.amount_due/100});__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['9']++;utils.sendEmail(emailContent.title,emailContent.text,activity.email,emailContent.subject,function(err){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['3']++;});});}else{__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['1'][1]++;}__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['10']++;if(ref.stripeEvent.type==='invoice.payment_succeeded'){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['2'][0]++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['11']++;console.log('stripe-webhook -> invoice.payment_succeeded',subObj);__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['12']++;subscriptionController.getSubscription(subObj.subscription,function(err,res){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['4']++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['13']++;utils.findSubscription({customerId:subObj.customer},function(err,subscription){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['5']++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['14']++;utils.updateSubscription({customerId:subObj.customer},{periodStart:subObj.period_start,periodEnd:subObj.period_end,frequency:res.frequency,cancelAtPeriodEnd:res.cancelAtPeriodEnd,status:res.status},function(err){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['6']++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['15']++;utils.checkActivity(subscription.oid,function(err,activity){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['7']++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['16']++;var emailContent=utils.formatEmailContent('invoice.payment_succeeded',{periodStart:utils.formatDateFromEpoch(res.periodStart),periodEnd:utils.formatDateFromEpoch(res.periodEnd)});__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['17']++;utils.sendEmail(emailContent.title,emailContent.text,activity.email,emailContent.subject,function(err){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['8']++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['18']++;if(typeof cb==='function'){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['3'][0]++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['19']++;cb(err);}else{__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['3'][1]++;}});});});});});}else{__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['2'][1]++;}__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['20']++;if(ref.stripeEvent.type==='invoice.payment_failed'){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['4'][0]++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['21']++;console.log('payment failed');__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['22']++;utils.findSubscription({customerId:subObj.customer},function(err,subscription){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['9']++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['23']++;console.log('subscription',subscription);__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['24']++;utils.checkActivity(subscription.oid,function(err,activity){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['10']++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['25']++;console.log('activity',activity);__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['26']++;if(subObj.next_payment_attempt!==null){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['5'][0]++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['27']++;var emailContent=utils.formatEmailContent('invoice.payment_failed',{attempt_count:utils.formatDateFromEpoch(subObj.attempt_count),next_payment_attempt:utils.formatDateFromEpoch(subObj.next_payment_attempt)});__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['28']++;utils.sendEmail(emailContent.title,emailContent.text,activity.email,emailContent.subject,function(err){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['11']++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['29']++;if(typeof cb==='function'){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['6'][0]++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['30']++;cb(err);}else{__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['6'][1]++;}});}else{__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['5'][1]++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['31']++;utils.updateSubscription({customerId:subObj.customer},{periodStart:null,periodEnd:null,frequency:null,cancelAtPeriodEnd:null,plan:'free',status:'inactive'},function(err){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['12']++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['32']++;utils.findSubscription({customerId:subObj.customer},function(err,subscription){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['13']++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['33']++;subscriptionController.cancelSubscription(subscription.subscriptionId,function(err,confirmation){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['14']++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['34']++;console.log('subscription called',err,confirmation);__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['35']++;var emailContent=utils.formatEmailContent('invoice.payment_failed_last',{});__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['36']++;utils.sendEmail(emailContent.title,emailContent.text,activity.email,emailContent.subject,function(err){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.f['15']++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['37']++;if(typeof cb==='function'){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['7'][0]++;__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['38']++;cb(err);}else{__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['7'][1]++;}});},false);});});}});});}else{__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['4'][1]++;}__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['39']++;if(ref.stripeEvent.type==='invoice.payment_succeeded'){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['8'][0]++;}else{__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['8'][1]++;}__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['40']++;if(ref.stripeEvent.type==='invoice.payment_succeeded'){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['9'][0]++;}else{__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['9'][1]++;}__cov_rYQ1ztjy4CjvY$3sjs_pLQ.s['41']++;if(ref.stripeEvent.type==='invoice.payment_succeeded'){__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['10'][0]++;}else{__cov_rYQ1ztjy4CjvY$3sjs_pLQ.b['10'][1]++;}};
